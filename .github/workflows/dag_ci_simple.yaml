# .github/workflows/dag_ci.yml
#
# This workflow runs CI checks on an Apache Airflow DAG project.
# It includes standard Python/Airflow tests and intentionally insecure
# configurations to test the Palo Alto Cortex XDR application security scanner.

name: Airflow DAG CI with Cortex XDR Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# --- INTENTIONALLY INSECURE CONFIGURATION 1 ---
# This top-level permissions block grants write-all access to the GITHUB_TOKEN.
# This is overly permissive and should be detected by a security scanner.
# A better practice is to define minimal permissions, e.g., `permissions: contents: read`
permissions: write-all

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        # Using a mutable tag (v4) instead of a specific commit SHA
        # is a common security practice violation.
        uses: actions/checkout@v4

      - name: Run Build Simulation
        run: |
          echo "Simulating a build step..."
          echo "This step contains hardcoded secrets for scanner testing."
        # --- INTENTIONALLY INSECURE CONFIGURATION 2 ---
        # Hardcoding secrets directly in the workflow file.
        # This is a critical vulnerability that Cortex XDR should immediately detect.
        # These keys are fake but follow a common pattern.
        env:
          PRISMA_API_KEY: "pa-12345-this-is-a-fake-but-detectable-key"
          SQL_DB_PASSWORD: "Password123!"

      - name: Run Palo Alto Cortex XDR Scan
        # This is the step where you integrate the Cortex XDR scanner.
        # You will need to find the specific action in the GitHub Marketplace
        # or from your Palo Alto documentation.
        run: |
          echo "Simulating Cortex XDR Scan..."
          echo "This step should be replaced with the official Palo Alto action."

        # --- EXAMPLE of what the real step might look like ---
        #
        # uses: paloaltonetworks/cortex-scan-action@v1
        # with:
        #   # Secrets must be stored in GitHub > Settings > Secrets > Actions
        #   cortex_api_key_id: ${{ secrets.CORTEX_API_KEY_ID }}
        #   cortex_api_key: ${{ secrets.CORTEX_API_KEY }}
        #   failure-threshold: 'high' # Fails the build on high-severity issues
